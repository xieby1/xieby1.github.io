<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link class="revealHref" rel="stylesheet" href="css/reset.css">
		<link class="revealHref" rel="stylesheet" href="css/reveal.css">
		<link class="revealHref" rel="stylesheet" href="css/theme/white.css">

		<!-- Theme used for syntax highlighting of code -->
		<link class="revealHref" rel="stylesheet" href="lib/css/monokai.css">

		<!-- The path to reveal.js folder. -->
		<script>
			let revealPath = "../../CrossPlatformTools/reveal.js/";
		</script>
		<script src="../../CrossPlatformTools/reveal.js/js/reveal.js"></script>

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.classList.add("revealHref");
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
		<script>
			for(let e of document.getElementsByClassName("revealHref"))
			{
				let oldHref = e.getAttribute("href");
				e.setAttribute("href", revealPath+oldHref);
			}
		</script>
		<style type="text/css">
			.floatBox {position: absolute; width: 50%; right: 0;
				/*box-shadow: 0 1px 4px rgba(0,0,0,0.5), 0 5px 25px rgba(0,0,0,0.2);*/
				background-color: rgba(0, 0, 0, 0.1); color: #333; padding: 10px;
				font-size: 20px; text-align: left;}
		</style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section>
					<h1>é‡ç”¨QEMUçš„ç³»ç»Ÿè°ƒç”¨helperçš„æ€è€ƒ</h1>
					<hr/>
					<small>-æœªå®Œæˆï¼Œä¹Ÿä¸æ‰“ç®—åšç©è¿™ä¸ªå¹»ç¯ç‰‡äº†-</small><br/>
					<b>The thinks of Reusing QEMU's System Call Helper</b>
					<div><br/>è°¢æœ¬å£¹ 2019.12.12</div>
				</section>
				<section>
					<h2>Outline</h2>
					<ol>
						<li>QEMUå¤„ç†ç³»ç»Ÿè°ƒç”¨çš„ä»£ç </li>
					</ol>
				</section>
				<section>
					<section>
						<h3>QEMUå¤„ç†ç³»ç»Ÿè°ƒç”¨çš„ä»£ç </h3>
						<img src="../QEMU/pictures/gen_exception.svg" style="border: white;" alt=""/>
						<div class="fragment floatBox" style="top: 12%; width: 30%;">
							è¿™æ¡æŒ‡ä»¤<b>è¿è¡Œ</b>æ—¶çš„æƒ…å½¢ï¼š
						</div>
						<div class="fragment floatBox" style="top: 28%; width: 30%;">
							1. æ›´æ–°Condition Code
						</div>
						<div class="fragment floatBox" style="top: 46%; width: 25%; left: 0">
							2. ä¿®æ”¹pcï¼Œä¸ºäº†ç²¾ç¡®ä¸­æ–­
						</div>
						<div class="fragment floatBox" style="top: 58%; width: 18%; left: 0">
							3. è°ƒç”¨helperå‡½æ•°
						</div>
						<div class="fragment floatBox" style="top: 85%; width: 30%;">
							4. è®¾ç½®æ¡æŒ‡ä»¤çš„è·³è½¬ç±»å‹
						</div>
						<div class="fragment floatBox" style="top: 73%; width: 20%; left: 0">
							<b>æœ€å¤§çš„é—®é¢˜</b>ï¼š<code>tcg_gen_callN</code>å®ç°äº†åœ¨nativeç¯å¢ƒè°ƒç”¨QEMUçš„å‡½æ•°çš„åŠŸèƒ½
						</div>
					</section>
					<section>
						<h3>QEMUå’ŒX86toMipsåˆ‡æ¢ç¯å¢ƒçš„ä¸åŒ</h3>
						<div style="zoom: 70%">
							<div style="float: left; width: 48%; text-align: center;">
								<h4>QEMU</h4>
								æ— å¯„å­˜å™¨æ˜ å°„
							</div>
							<div style="float: right; width: 48%; text-align: center;">
								<h4>X86toMips</h4>
								æœ‰å¯„å­˜å™¨æ˜ å°„
							</div>
						</div>
						<table class="fragment" style="zoom: 70%">
							<tr>
								<th></th>
								<th>0</th>
								<th>1</th>
								<th>2</th>
								<th>3</th>
							</tr>
							<tr>
								<td>0</td>
								<td>zero <span style="font-weight:bold">ZERO</span></td>
								<td>at <span style="font-weight:bold;color:rgb(203, 0, 0)">EDX</span></td>
								<td>v0 <span style="font-weight:bold;color:rgb(203, 0, 0)">EAX</span></td>
								<td>v1 <span style="font-weight:bold;color:rgb(203, 0, 0)">ECX</span></td>
							</tr>
							<tr>
								<td>4</td>
								<td>a0 <span style="font-weight:bold;color:rgb(49, 102, 255)">TMP</span></td>
								<td>a1 <span style="font-weight:bold;color:rgb(49, 102, 255)">TMP</span></td>
								<td>a2 <span style="font-weight:bold;color:rgb(49, 102, 255)">TMP</span></td>
								<td>a3 <span style="font-weight:bold;color:rgb(49, 102, 255)">TMP</span></td>
							</tr>
							<tr>
								<td>8</td>
								<td>a4 <span style="font-weight:bold;color:rgb(49, 102, 255)">TMP</span></td>
								<td>a5 <span style="font-weight:bold;color:rgb(49, 102, 255)">TMP</span></td>
								<td>a6 <span style="font-weight:bold;color:rgb(49, 102, 255)">TMP</span></td>
								<td>a7 <span style="font-weight:bold;color:rgb(49, 102, 255)">TMP</span></td>
							</tr>
							<tr>
								<td>12</td>
								<td>t0 <span style="font-weight:bold;color:rgb(49, 102, 255)">TMP</span></td>
								<td>t1 <span style="font-weight:bold;color:rgb(49, 102, 255)">TMP</span></td>
								<td>t2 <span style="font-weight:bold">GuestBase</span></td>
								<td>t3 <span style="font-weight:bold;color:rgb(192, 192, 192)">ForFutureUse</span></td>
							</tr>
							<tr>
								<td>16</td>
								<td><span style="color:white;background:black;">s0</span> <span style="font-weight:bold;color:rgb(101, 101, 101)">n1</span></td>
								<td><span style="color:white;background:black;">s1</span> <span style="font-weight:bold;color:rgb(203, 0, 0)">SS</span></td>
								<td><span style="color:white;background:black;">s2</span> <span style="font-weight:bold;color:rgb(255, 199, 2)">ENV</span></td>
								<td><span style="color:white;background:black;">s3</span> <span style="font-weight:bold;color:rgb(203, 0, 0)">EBX</span></td>
							</tr>
							<tr>
								<td>20</td>
								<td><span style="color:white;background:black;">s4</span> <span style="font-weight:bold;color:rgb(203, 0, 0)">ESP</span></td>
								<td><span style="color:white;background:black;">s5</span> <span style="font-weight:bold;color:rgb(203, 0, 0)">EBP</span></td>
								<td><span style="color:white;background:black;">s6</span> <span style="font-weight:bold;color:rgb(203, 0, 0)">ESI</span></td>
								<td><span style="color:white;background:black;">s7</span> <span style="font-weight:bold;color:rgb(203, 0, 0)">EDI</span></td>
							</tr>
							<tr>
								<td>24</td>
								<td>t8 <span style="font-weight:bold;color:rgb(0, 153, 1)">DBT</span></td>
								<td>t9 <span style="font-weight:bold;color:rgb(0, 153, 1)">DBT</span></td>
								<td>k0</td>
								<td>k1</td>
							</tr>
							<tr>
								<td>28</td>
								<td><span style="color:white;background:black;">gp</span> <span style="font-weight:bold;color:rgb(0, 210, 203)">TOP</span></td>
								<td>sp <span style="font-weight:bold">SP</span></td>
								<td><span style="color:white;background:black;">fp</span> <span style="font-weight:bold;color:rgb(203, 0, 0)">EFLAGS</span></td>
								<td><span style="color:white;background:black;">ra</span> <span style="font-weight:bold;color:rgb(0, 210, 203)">MDA</span>?</td>
							</tr>
						</table>
						<div class="fragment" style="zoom: 50%">
							<span style="color:white;background:black;">mips-reg</span>,
							<span style="font-weight:bold;color:rgb(49, 102, 255)">TMP</span>,
							<span style="font-weight:bold;color:rgb(203, 0, 0)">x86-reg</span>,
							<span style="font-weight:bold;color:rgb(255, 199, 2)">ENV</span>,
							<span style="font-weight:bold;color:rgb(0, 153, 1)">DBTå†…éƒ¨ä½¿ç”¨</span>,
							<span style="font-weight:bold;color:rgb(0, 210, 203)">æµ®ç‚¹ä½¿ç”¨</span>
						</div>
						<div class="fragment floatBox" style="top: 40%; width: 20%;">
							<b>éš¾é¢˜:</b>
							<ul>
								<li class="fragment">MIPS N64ç³»ç»Ÿè°ƒç”¨ABIï¼šè°ƒç”¨å·æ”¾åœ¨v0ï¼Œå’Œx86æ˜ å°„å¯„å­˜å™¨å†²çª</li>
								<li class="fragment">MIPS N64ç³»ç»Ÿè°ƒç”¨ABIï¼šå‚æ•°æ”¾åœ¨a0~a3ï¼Œå’ŒX86toMipsçš„ä¸´æ—¶å¯„å­˜å†²çª</li>
							</ul>
						</div>
					</section>
				</section>
				<section>
					<section>
						<h3>è§£å†³æ–¹æ³•</h3>
						å°†helperå‡½æ•°çš„å‚æ•°å»æ‰ï¼
					</section>
					<section data-markdown>
						* ä¿å­˜ä¸­æ–­å¤„ç†ä»£ç éœ€è¦çš„å˜é‡ï¼ˆè·Ÿè¸ªhelperä»£ç ï¼Œä¾¿å¯å¾—ä¸‹é¢è¿™äº›å˜é‡ï¼‰
						  * ğŸ”§ä¸­æ–­å·`intno`ï¼Œ
						  * `error_code=0`ï¼Œ
						  * æ˜¯ä¸­æ–­è¿˜æ˜¯å¼‚å¸¸`is_int=1`ï¼ŒğŸ¤”**æœ‰å¿…è¦è°ƒç ”ä¸€ä¸‹åœ¨QEMUé‡Œï¼ˆä¸æ˜¯X86é‡Œï¼‰çš„ä¸­æ–­å’Œå¼‚å¸¸åˆ†åˆ«æ˜¯ä»€ä¹ˆæ„æ€**ï¼Œ
						  * ğŸ”§ä¸­æ–­æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€`exception_next_eip`ï¼Œ
						  * CPUå¯ä»¥æ‰§è¡ŒIO`can_do_io=1`ï¼Œ
						* `siglongjmp`ï¼Œ

						åªæœ‰ä¸¤ä¸ªå˜é‡éœ€è¦ä¿®æ”¹ğŸ”§
					</section>
					<section data-markdown>
						```
						bool translate_int(IR1_INST *pir1) {
						// * store registers to env, or if context_switch_native_to_bt is better?
						tr_save_registers_to_env(0xff, 0xff, 0xff, 0xff);

						// * store intno to CPUState
						IR2_OPND intno = ra_alloc_itemp();
						load_ireg_from_addrx(intno, pir1->_opnd[0]._ubyte);
						append_ir2_opnd2i(mips_sw, intno, env_ir2_opnd, lsenv_offset_exception_index(lsenv));

						// * store next pc to CPUX86State
						IR2_OPND next_pc = ra_alloc_itemp();
						load_ireg_from_addrx(next_pc, pir1->_inst_length + pir1->_addr);
						append_ir2_opnd2i(mips_sw, next_pc, env_ir2_opnd, lsenv_offset_exception_next_eip(lsenv));
						```
						```
						// * call helper function
						IR2_OPND helper_addr_opnd = ra_alloc_dbt_arg2();
						load_ireg_from_addr(helper_addr_opnd, (ADDR)helper_raise_int);
						append_ir2_opnd1(mips_jalr, helper_addr_opnd);

						return true;
						}
						```
					</section>
				</section>
				<section>
					ä¸‹å‘¨çš„è®¡åˆ’
				</section>
			</div>
		</div>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				controls: true,
				progress: true,
				center: true,
				hash: true,
				slideNumber: true,
				pdfSeparateFragments: false,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				dependencies: [
					{ src: revealPath + 'plugin/markdown/marked.js' },
					{ src: revealPath + 'plugin/markdown/markdown.js' },
					{ src: revealPath + 'plugin/notes/notes.js', async: true },
					{ src: revealPath + 'plugin/highlight/highlight.js', async: true },
					{ src: revealPath + 'plugin/zoom-js/zoom.js', async: true }
				]
			});
		</script>
	</body>
</html>
